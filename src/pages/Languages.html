<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Tour Guide Admin Panel</title>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r shadow-md">
        <div class="flex items-center border-b justify-center h-20">
          <img
            src="../img/Header.svg"
            alt="logo header"
            class="h-96 object-contain flex items-start justify-start"
          />
        </div>
        <nav class="p-4 space-y-3">
          <a
            href="home.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="map"></i> <span>Trips</span>
          </a>
          <a
            href="categories.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="folder"></i> <span>Categories</span>
          </a>
          <a
            href="includes.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="check-square"></i> <span>Includes</span>
          </a>
          <a
            href="Languages.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 bg-blue-100 shadow-inner font-medium"
          >
            <i data-lucide="languages"></i> <span>Languages</span>
          </a>
          <a
            href="activities.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="activity"></i> <span>Activities</span>
          </a>
          <a
            href="booking.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="calendar-check"></i> <span>Bookings</span>
          </a>
          <a
            href="#"
            id="logoutBtn"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-100"
          >
            <i data-lucide="log-out"></i> <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
        >
          <h1 class="text-3xl font-bold text-gray-900">Manage Languages</h1>
          <button
            id="refreshBtn"
            class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
          >
            <i data-lucide="refresh-ccw" class="h-4 w-4"></i> Refresh
          </button>
        </div>

        <!-- Filters row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Search -->
          <div class="col-span-2">
            <label for="searchInput" class="sr-only">Search Language</label>
            <div class="relative">
              <i
                data-lucide="search"
                class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"
              ></i>
              <input
                id="searchInput"
                type="text"
                placeholder="Search language..."
                class="w-full border border-gray-200 rounded-xl pl-10 pr-4 py-2.5 bg-white shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              />
            </div>
          </div>

          <!-- Count -->
          <div class="flex items-center justify-between md:justify-end">
            <div id="langCount" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <!-- Table Card -->
        <div
          class="bg-white rounded-2xl shadow ring-1 ring-gray-200 overflow-hidden"
        >
          <div
            class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b"
          >
            <div class="text-sm text-gray-600">Languages</div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead
                class="sticky top-0 z-10 bg-gray-50/95 backdrop-blur supports-[backdrop-filter]:bg-gray-50/75 text-gray-600 text-xs uppercase"
              >
                <tr>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="id"
                    >
                      <span>ID</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="name"
                    >
                      <span>Language</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                </tr>
              </thead>
              <tbody
                id="langTable"
                class="divide-y divide-gray-100 bg-white"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div
          id="pagination"
          class="mt-6 flex justify-center items-center gap-3 text-sm font-medium"
        ></div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide?.createIcons) lucide.createIcons();
      });

      // Elements
      const tableBody = document.getElementById("langTable");
      const searchInput = document.getElementById("searchInput");
      const refreshBtn = document.getElementById("refreshBtn");
      const countEl = document.getElementById("langCount");

      // State
      let allLanguages = [];
      let currentPage = 1;
      const pageSize = 12;
      let searchTerm = "";
      let sortState = { key: null, dir: "asc" }; // id | name

      // ===== UI helpers =====
      function showSkeleton(rows = 10) {
        let html = "";
        for (let i = 0; i < rows; i++) {
          html += `
            <tr class="hover:bg-gray-50/70">
              <td class="px-6 py-4"><div class="h-4 w-16 rounded tg-shimmer"></div></td>
              <td class="px-6 py-4"><div class="h-4 w-52 rounded tg-shimmer"></div></td>
            </tr>`;
        }
        tableBody.innerHTML = html;
      }

      function sanitize(text) {
        return (text ?? "").toString();
      }

      // ===== Sorting / Filtering / Paging =====
      function applySort(items) {
        if (!Array.isArray(items) || !sortState.key) return items || [];
        const dir = sortState.dir === "desc" ? -1 : 1;
        const key = sortState.key;
        return [...items].sort((a, b) => {
          let va = a[key];
          let vb = b[key];
          if (key === "id") {
            va = Number(va);
            vb = Number(vb);
          }
          va = (va ?? "").toString().toLowerCase();
          vb = (vb ?? "").toString().toLowerCase();
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return 0;
        });
      }

      function updateSortBadges() {
        document.querySelectorAll("thead [data-sort]").forEach((btn) => {
          const badge = btn.querySelector(".sort-badge");
          if (!badge) return;
          const active = sortState.key === btn.dataset.sort;
          badge.classList.toggle("hidden", !active);
          if (active) badge.textContent = sortState.dir === "asc" ? "▲" : "▼";
        });
      }

      function setupTableSort() {
        document.querySelectorAll("thead [data-sort]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.sort;
            if (!key) return;
            if (sortState.key === key) {
              sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
            } else {
              sortState.key = key;
              sortState.dir = "asc";
            }
            updateSortBadges();
            render(); // re-render current page
          });
        });
      }

      function getFiltered() {
        const q = searchTerm.trim().toLowerCase();
        if (!q) return [...allLanguages];
        return allLanguages.filter(
          (l) =>
            sanitize(l.name).toLowerCase().includes(q) ||
            sanitize(l.id).toLowerCase().includes(q)
        );
      }

      function paginate(list, page, size) {
        const start = (page - 1) * size;
        return list.slice(start, start + size);
      }

      // ===== Rendering =====
      function render() {
        const filtered = getFiltered();
        const sorted = applySort(filtered);
        const pageItems = paginate(sorted, currentPage, pageSize);

        // Count badge
        countEl.textContent = `${filtered.length} language${
          filtered.length === 1 ? "" : "s"
        }`;

        tableBody.innerHTML = "";

        if (!pageItems.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="2" class="px-6 py-12">
                <div class="flex items-center justify-center gap-3 text-gray-600">
                  <i data-lucide="languages" class="h-5 w-5"></i>
                  <span>No languages found</span>
                </div>
              </td>
            </tr>`;
          if (window.lucide?.createIcons) lucide.createIcons();
          renderPagination(1, 1); // empty state
          return;
        }

        // Build rows using DOM APIs (safe)
        pageItems.forEach((lang) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 transition-colors";

          const tdId = document.createElement("td");
          tdId.className = "px-6 py-4";
          tdId.innerHTML = `<span class="inline-flex items-center justify-center h-7 w-10 rounded-lg bg-indigo-600/10 text-indigo-700 ring-1 ring-indigo-200 tabular-nums font-semibold">${sanitize(
            lang.id
          )}</span>`;

          const tdName = document.createElement("td");
          tdName.className = "px-6 py-4";
          tdName.textContent = sanitize(lang.name);

          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tableBody.appendChild(tr);
        });

        if (window.lucide?.createIcons) lucide.createIcons();
        renderPagination(currentPage, filtered.length);
      }

      function renderPagination(current, totalItems) {
        const container = document.getElementById("pagination");
        const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
        container.innerHTML = "";

        const group = document.createElement("div");
        group.className =
          "inline-flex overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white shadow-sm";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.disabled = current === 1;
        prevBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        prevBtn.onclick = () => {
          if (current > 1) {
            currentPage--;
            render();
          }
        };

        const info = document.createElement("span");
        info.className = "px-4 py-2 text-gray-600 border-x border-gray-200";
        info.textContent = `Page ${current} of ${totalPages}`;

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = current === totalPages;
        nextBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        nextBtn.onclick = () => {
          if (current < totalPages) {
            currentPage++;
            render();
          }
        };

        group.appendChild(prevBtn);
        group.appendChild(info);
        group.appendChild(nextBtn);
        container.appendChild(group);
      }

      // ===== Data =====
      async function loadLanguages() {
        try {
          showSkeleton();
          const res = await fetch(`/api/Language/GetAllLanguages`);
          const data = await res.json();

          if (res.ok && (data.succeeded ?? true)) {
            allLanguages = Array.isArray(data.data) ? data.data : [];
            currentPage = 1;
            render();
          } else {
            tableBody.innerHTML = `
              <tr>
                <td colspan="2" class="px-6 py-8 text-center text-red-500">Failed to load languages</td>
              </tr>`;
          }
        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `
            <tr>
              <td colspan="2" class="px-6 py-8 text-center text-red-500">Network error loading languages</td>
            </tr>`;
        }
      }

      // ===== Events =====
      searchInput.addEventListener("input", () => {
        searchTerm = searchInput.value;
        currentPage = 1;
        render();
      });

      refreshBtn.addEventListener("click", () => {
        loadLanguages();
      });

      setupTableSort();
      loadLanguages();
    </script>
    <script src="../js/logout.js" defer></script>
  </body>
</html>
