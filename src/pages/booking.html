<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html[data-auth="checking"] body {
        visibility: hidden;
      }
    </style>
    <script>
      document.documentElement.setAttribute("data-auth", "checking");
    </script>
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script
      src="../js/auth-guard.js"
      defer
      data-redirect="../index.html"
    ></script>

    <title>Tour Guide Admin Panel</title>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r shadow-md">
        <div class="flex items-center border-b justify-center h-20">
          <img
            src="../img/Header.svg"
            alt="logo header"
            class="h-96 object-contain flex items-start justify-start"
          />
        </div>
        <nav class="p-4 space-y-3">
          <a
            href="home.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="map"></i> <span>Trips</span>
          </a>
          <a
            href="categories.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="folder"></i> <span>Categories</span>
          </a>
          <a
            href="includes.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="check-square"></i> <span>Includes</span>
          </a>
          <a
            href="Languages.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="languages"></i> <span>Languages</span>
          </a>
          <a
            href="activities.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="activity"></i> <span>Activities</span>
          </a>
          <a
            href="booking.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 bg-blue-100 shadow-inner font-medium"
          >
            <i data-lucide="calendar-check"></i> <span>Bookings</span>
          </a>
          <a
            href="#"
            id="logoutBtn"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-100"
          >
            <i data-lucide="log-out"></i> <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
        >
          <h1 class="text-3xl font-bold text-gray-900">Manage Bookings</h1>
          <button
            id="refreshBtn"
            class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
          >
            <i data-lucide="refresh-ccw" class="h-4 w-4"></i> Refresh
          </button>
        </div>

        <!-- Filters: Search + Status + Sort -->
        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <!-- Search -->
          <div class="md:col-span-1">
            <label for="searchInput" class="sr-only">Search Booking</label>
            <div class="relative">
              <i
                data-lucide="search"
                class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"
              ></i>
              <input
                id="searchInput"
                type="text"
                placeholder="Search name, phone, trip, ID…"
                class="w-full border border-gray-200 rounded-xl pl-10 pr-4 py-2.5 bg-white shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              />
            </div>
          </div>

          <!-- Booking Status -->
          <div class="">
            <label for="statusFilter" class="sr-only">Booking status</label>
            <select
              id="statusFilter"
              class="w-full border border-gray-200 rounded-xl px-3 py-2.5 bg-white text-gray-800 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              aria-label="Filter by booking status"
            >
              <option value="">All statuses</option>
              <option value="Pending">Pending</option>
              <option value="Declined">Declined</option>
              <option value="Confirmed">Confirmed</option>
            </select>
          </div>

          <!-- Sort -->
          <div class="">
            <label for="sortSelect" class="sr-only">Sort</label>
            <select
              id="sortSelect"
              class="w-full border border-gray-200 rounded-xl px-3 py-2.5 bg-white text-gray-800 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              aria-label="Sort bookings"
            >
              <option value="">Sort by…</option>
              <option value="tripdate:asc">Trip date ↑ (oldest first)</option>
              <option value="tripdate:desc">Trip date ↓ (newest first)</option>
              <option value="createdat:asc">Created at ↑ (oldest first)</option>
              <option value="createdat:desc">
                Created at ↓ (newest first)
              </option>
            </select>
          </div>
        </div>

        <!-- Stats / Counts -->
        <div id="pageStats" class="mb-4 text-sm text-gray-600"></div>

        <!-- Bookings Table -->
        <div
          class="bg-white rounded-2xl shadow ring-1 ring-gray-200 overflow-hidden"
        >
          <div
            class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b"
          >
            <div class="text-sm text-gray-600">Bookings</div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead
                class="sticky top-0 z-10 bg-gray-50/95 backdrop-blur supports-[backdrop-filter]:bg-gray-50/75 text-gray-600 text-xs uppercase"
              >
                <tr>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    Name
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    Trip
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="tripdate"
                    >
                      <span>Trip Date</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    Cost
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="createdat"
                    >
                      <span>Created At</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    Status
                  </th>
                </tr>
              </thead>
              <tbody
                id="bookingTable"
                class="divide-y divide-gray-100 bg-white"
              ></tbody>
            </table>
          </div>
        </div>

        <div
          id="pagination"
          class="mt-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3 text-sm font-medium"
        >
          <!-- Filled by JS -->
        </div>
      </main>
    </div>

    <!-- Toast -->
    <div
      id="toastRoot"
      class="fixed top-4 right-4 z-[60] space-y-2 pointer-events-none"
    ></div>

    <!-- Booking Modal -->
    <div
      id="bookingModal"
      class="fixed inset-0 z-50 hidden overflow-y-auto"
      aria-hidden="true"
    >
      <!-- Overlay -->
      <div
        id="bookingModalOverlay"
        class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity"
      ></div>

      <!-- Panel -->
      <div
        id="bookingModalPanel"
        class="relative mx-auto my-10 w-[min(96vw,860px)] opacity-0 translate-y-6 transition-all"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl ring-1 ring-black/5 overflow-hidden flex flex-col max-h-[90vh]"
        >
          <!-- Header -->
          <div
            class="px-6 pt-5 pb-3 border-b bg-gradient-to-r from-blue-600/5 to-indigo-600/5"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span
                  class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-blue-50 ring-1 ring-blue-100"
                >
                  <i data-lucide="calendar-check" class="text-blue-600"></i>
                </span>
                <div>
                  <h3 id="bm-title" class="text-lg font-semibold text-gray-900">
                    Booking
                  </h3>
                  <p id="bm-subtitle" class="text-xs text-gray-500">—</p>
                </div>
              </div>
              <button
                id="bm-close"
                class="p-2 rounded-lg hover:bg-gray-100 transition"
                aria-label="Close"
              >
                <i data-lucide="x"></i>
              </button>
            </div>

            <!-- Segmented tabs -->
            <div class="mt-3">
              <div
                class="inline-flex rounded-full bg-white/60 p-1 ring-1 ring-gray-200"
                role="tablist"
                aria-label="Booking views"
              >
                <button
                  id="bm-tab-summary"
                  class="rounded-full px-4 py-1.5 text-sm font-medium bg-white text-gray-900 shadow"
                  role="tab"
                  aria-selected="true"
                  aria-controls="bm-pane-summary"
                  type="button"
                >
                  Summary
                </button>
                <button
                  id="bm-tab-edit"
                  class="rounded-full px-4 py-1.5 text-sm font-medium text-gray-700 hover:text-gray-900"
                  role="tab"
                  aria-selected="false"
                  aria-controls="bm-pane-edit"
                  type="button"
                >
                  Edit
                </button>
              </div>
            </div>
          </div>

          <!-- Body -->
          <div
            id="bm-body"
            class="px-6 py-5 flex-1 overflow-y-auto overscroll-contain custom-scroll"
          >
            <!-- Loading -->
            <div id="bm-loading" class="flex items-center gap-3 text-gray-500">
              <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                ></path>
              </svg>
              Loading details…
            </div>

            <!-- Error -->
            <div id="bm-error" class="hidden">
              <div
                class="rounded-xl bg-red-50 text-red-700 border border-red-200 p-4"
              >
                <div class="font-medium">Couldn’t load booking.</div>
                <div id="bm-errorMsg" class="text-sm opacity-90 mt-1"></div>
              </div>
            </div>

            <!-- SUMMARY PANE -->
            <section
              id="bm-pane-summary"
              role="tabpanel"
              aria-labelledby="bm-tab-summary"
              class="hidden"
            >
              <!-- Top cards -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="rounded-xl border p-4">
                  <p class="text-xs text-gray-500 mb-1">Guest</p>
                  <div class="flex items-center gap-3">
                    <div
                      class="h-9 w-9 rounded-lg bg-indigo-600/10 text-indigo-700 ring-1 ring-indigo-200 flex items-center justify-center font-semibold"
                    >
                      <span id="bm-userInitial">?</span>
                    </div>
                    <div>
                      <p class="font-medium text-gray-900" id="bm-userName">
                        —
                      </p>
                      <div class="flex items-center gap-2">
                        <span id="bm-phone" class="text-sm text-gray-600"
                          >—</span
                        >
                        <button
                          id="bm-copyPhone"
                          class="text-xs text-blue-600 hover:underline"
                        >
                          Copy
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="rounded-xl border p-4">
                  <p class="text-xs text-gray-500 mb-1">Trip</p>
                  <p class="font-medium text-gray-900" id="bm-tripName">—</p>
                  <p class="text-sm text-gray-600">
                    <span id="bm-tripDate">—</span>
                  </p>
                </div>

                <div class="rounded-xl border p-4">
                  <p class="text-xs text-gray-500 mb-1">Party</p>
                  <p class="text-sm text-gray-800">
                    Adults: <span id="bm-adults">0</span> &nbsp;·&nbsp;
                    Children: <span id="bm-children">0</span>
                  </p>
                </div>

                <div class="rounded-xl border p-4">
                  <p class="text-xs text-gray-500 mb-1">Status</p>
                  <div
                    id="bm-statusPill"
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700"
                  >
                    —
                  </div>
                </div>
              </div>

              <!-- Meta strip -->
              <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl bg-gray-50 border p-3 text-sm">
                  <div class="text-gray-500 text-xs mb-0.5">Total</div>
                  <div id="bm-total" class="font-semibold text-gray-900">—</div>
                </div>
                <div class="rounded-xl bg-gray-50 border p-3 text-sm">
                  <div class="text-gray-500 text-xs mb-0.5">Booking ID</div>
                  <div class="flex items-center gap-2">
                    <span id="bm-publicId" class="text-gray-900">—</span>
                    <button
                      id="bm-copyId"
                      class="text-xs text-blue-600 hover:underline"
                    >
                      Copy
                    </button>
                  </div>
                </div>
                <div class="rounded-xl bg-gray-50 border p-3 text-sm">
                  <div class="text-gray-500 text-xs mb-0.5">Created</div>
                  <div id="bm-created" class="text-gray-900">—</div>
                </div>
              </div>
            </section>

            <!-- EDIT PANE -->
            <section
              id="bm-pane-edit"
              role="tabpanel"
              aria-labelledby="bm-tab-edit"
              class="hidden"
            >
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-semibold text-gray-900">
                  Adjust before confirming / declining
                </h4>
                <span class="text-xs text-gray-500"
                  >Times interpreted in <strong>Africa/Cairo</strong>.</span
                >
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label
                    for="bm-edit-adults"
                    class="block text-xs text-gray-600 mb-1"
                    >Adults</label
                  >
                  <input
                    id="bm-edit-adults"
                    type="number"
                    min="0"
                    max="2147483647"
                    class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 px-3 py-2"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label
                    for="bm-edit-children"
                    class="block text-xs text-gray-600 mb-1"
                    >Children</label
                  >
                  <input
                    id="bm-edit-children"
                    type="number"
                    min="0"
                    max="2147483647"
                    class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 px-3 py-2"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label
                    for="bm-edit-datetime"
                    class="block text-xs text-gray-600 mb-1"
                    >Trip date & time</label
                  >
                  <input
                    id="bm-edit-datetime"
                    type="datetime-local"
                    class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 px-3 py-2"
                  />
                </div>
              </div>
            </section>
          </div>

          <!-- Footer -->
          <div
            class="px-6 py-4 border-t bg-gray-50 flex items-center justify-between"
          >
            <div class="text-xs text-gray-500">
              Press
              <kbd class="px-1.5 py-0.5 bg-white border rounded">Esc</kbd> to
              close.
            </div>
            <div class="flex items-center gap-2">
              <button
                id="bm-delete"
                class="inline-flex items-center gap-2 rounded-xl bg-white text-red-600 border border-red-200 px-4 py-2 font-semibold hover:bg-red-50 disabled:opacity-60 disabled:cursor-not-allowed"
                disabled
              >
                <i data-lucide="trash-2" class="h-4 w-4"></i>
                Delete
              </button>
              <button
                id="bm-cancel"
                class="inline-flex items-center gap-2 rounded-xl bg-rose-600 text-white px-4 py-2 font-semibold shadow hover:bg-rose-700 active:bg-rose-800 disabled:opacity-60 disabled:cursor-not-allowed"
                disabled
              >
                <i data-lucide="x-circle" class="h-4 w-4"></i>
                Decline
              </button>
              <button
                id="bm-confirm"
                class="inline-flex items-center gap-2 rounded-xl bg-green-600 text-white px-4 py-2 font-semibold shadow hover:bg-green-700 active:bg-green-800 disabled:opacity-60 disabled:cursor-not-allowed"
                disabled
              >
                <i data-lucide="check-circle" class="h-4 w-4"></i>
                Save & confirm
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="../js/ui.js" defer></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide?.createIcons) lucide.createIcons();
      });

      // ---------- Config ----------
      const ENDPOINTS = {
        bookings: "/api/Booking/GetAllBookings",
        refresh: "/api/Auth/GetToken",
        getBooking: (id) =>
          `/api/Booking/GetBookingById/${encodeURIComponent(id)}`,
        deleteBooking: (id) =>
          `/api/Booking/DeleteBooking/${encodeURIComponent(id)}`,
        updateBooking: (id) =>
          `/api/Booking/UpdateBooking/${encodeURIComponent(id)}`,
      };

      // Pagination + Search state
      let currentPage = 1;
      const pageSize = 8;
      let currentSearch = "";
      let currentStatus = ""; // BookingStatus
      let currentSort = ""; // e.g. "tripdate:desc"
      let loading = false;

      // ---------- Token helpers ----------
      function getStoredToken() {
        return (
          localStorage.getItem("accessToken") ||
          localStorage.getItem("token") ||
          localStorage.getItem("jwt") ||
          null
        );
      }
      function setStoredToken(token) {
        if (!token) return;
        localStorage.setItem("accessToken", token);
        localStorage.setItem("token", token);
      }
      function extractTokenFromResponse(json) {
        if (!json) return null;
        if (typeof json.token === "string") return json.token;
        if (json.data && typeof json.data.token === "string")
          return json.data.token;
        if (json.data && typeof json.data.accessToken === "string")
          return json.data.accessToken;
        if (typeof json.accessToken === "string") return json.accessToken;
        return null;
      }
      async function refreshToken() {
        const res = await fetch(ENDPOINTS.refresh, {
          method: "POST",
          credentials: "include",
        });
        if (!res.ok) throw new Error("Failed to refresh token");
        const json = await res.json().catch(() => ({}));
        const newToken = extractTokenFromResponse(json);
        if (!newToken)
          throw new Error("Refresh endpoint did not return a token");
        setStoredToken(newToken);
        return newToken;
      }
      async function authorizedFetch(
        url,
        options = {},
        { retryOn401 = true } = {}
      ) {
        const headers = new Headers(options.headers || {});
        const token = getStoredToken();
        if (token) headers.set("Authorization", `Bearer ${token}`);

        let res = await fetch(url, { ...options, headers });

        if (res.status === 401 && retryOn401) {
          const newToken = await refreshToken();
          const retryHeaders = new Headers(options.headers || {});
          retryHeaders.set("Authorization", `Bearer ${newToken}`);
          res = await fetch(url, { ...options, headers: retryHeaders });
        }
        return res;
      }

      // ---------- UI refs ----------
      const tableBody = document.getElementById("bookingTable");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");
      const sortSelect = document.getElementById("sortSelect");
      const paginationEl = document.getElementById("pagination");
      const statsEl = document.getElementById("pageStats");
      const refreshBtn = document.getElementById("refreshBtn");

      // Modal refs
      const modalRoot = document.getElementById("bookingModal");
      const modalOverlay = document.getElementById("bookingModalOverlay");
      const modalPanel = document.getElementById("bookingModalPanel");
      const modalCloseBtn = document.getElementById("bm-close");

      const bmTitle = document.getElementById("bm-title");
      const bmSubtitle = document.getElementById("bm-subtitle");
      const bmLoading = document.getElementById("bm-loading");
      const bmError = document.getElementById("bm-error");
      const bmErrorMsg = document.getElementById("bm-errorMsg");

      const bmUserName = document.getElementById("bm-userName");
      const bmPhone = document.getElementById("bm-phone");
      const bmTripName = document.getElementById("bm-tripName");
      const bmTripDate = document.getElementById("bm-tripDate");
      const bmAdults = document.getElementById("bm-adults");
      const bmChildren = document.getElementById("bm-children");
      const bmStatusPill = document.getElementById("bm-statusPill");
      const bmTotal = document.getElementById("bm-total");
      const bmPublicId = document.getElementById("bm-publicId");
      const bmCreated = document.getElementById("bm-created");

      const bmBtnDelete = document.getElementById("bm-delete");
      const bmBtnCancel = document.getElementById("bm-cancel"); // Decline
      const bmBtnConfirm = document.getElementById("bm-confirm");

      // Editor refs
      const bmEditAdults = document.getElementById("bm-edit-adults");
      const bmEditChildren = document.getElementById("bm-edit-children");
      const bmEditDatetime = document.getElementById("bm-edit-datetime");

      // ---- NEW: refs for tabs/panes + helpers
      const bmTabSummary = document.getElementById("bm-tab-summary");
      const bmTabEdit = document.getElementById("bm-tab-edit");
      const bmPaneSummary = document.getElementById("bm-pane-summary");
      const bmPaneEdit = document.getElementById("bm-pane-edit");
      const bmUserInitial = document.getElementById("bm-userInitial");
      const bmCopyPhone = document.getElementById("bm-copyPhone");
      const bmCopyId = document.getElementById("bm-copyId");

      // show tab
      function showBookingTab(which = "summary") {
        const isSummary = which === "summary";
        bmTabSummary.setAttribute(
          "aria-selected",
          isSummary ? "true" : "false"
        );
        bmTabEdit.setAttribute("aria-selected", isSummary ? "false" : "true");

        bmTabSummary.classList.toggle("bg-white", isSummary);
        bmTabSummary.classList.toggle("text-gray-900", isSummary);
        bmTabSummary.classList.toggle("shadow", isSummary);
        bmTabEdit.classList.toggle("bg-white", !isSummary);
        bmTabEdit.classList.toggle("text-gray-900", !isSummary);
        bmTabEdit.classList.toggle("shadow", !isSummary);

        bmPaneSummary.classList.toggle("hidden", !isSummary);
        bmPaneEdit.classList.toggle("hidden", isSummary);

        // enable/disable confirm button depending on tab + validity
        bmBtnConfirm.disabled = isSummary || !isEditorValid() || modalBusy;
      }

      // wire buttons
      bmTabSummary?.addEventListener("click", () => showBookingTab("summary"));
      bmTabEdit?.addEventListener("click", () => showBookingTab("edit"));

      // copy helpers
      bmCopyPhone?.addEventListener("click", () => {
        const txt = (bmPhone?.textContent || "").trim();
        if (!txt) return;
        navigator.clipboard
          .writeText(txt)
          .then(() =>
            tgToast({ variant: "success", message: "Phone copied." })
          );
      });
      bmCopyId?.addEventListener("click", () => {
        const txt = (bmPublicId?.textContent || "").trim();
        if (!txt) return;
        navigator.clipboard
          .writeText(txt)
          .then(() => tgToast({ variant: "success", message: "ID copied." }));
      });
      // Server-paged data for the current page
      let pageRows = [];
      let totalCount = 0;

      // Current modal booking
      let currentModalBooking = null;
      let modalBusy = false;

      // ---------- Formatters ----------
      function formatMoney(value) {
        if (typeof value !== "number") value = Number(value) || 0;
        return (
          "€" +
          value.toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          })
        );
      }
      function parseISOGuessTZ(iso) {
        if (!iso) return null;
        const hasTZ = /[zZ]|[+\-]\d{2}:\d{2}$/.test(iso);
        const fixed = hasTZ ? iso : iso + "Z";
        const d = new Date(fixed);
        return isNaN(d) ? null : d;
      }
      function formatDateLocal(iso) {
        const d = parseISOGuessTZ(iso);
        if (!d) return "-";
        try {
          return new Intl.DateTimeFormat("en-GB", {
            timeZone: "Africa/Cairo",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          }).format(d);
        } catch {
          return d.toLocaleString("en-GB");
        }
      }
      function toDatetimeLocalValue(iso) {
        const d = parseISOGuessTZ(iso);
        if (!d) return "";
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function datetimeLocalToISO(val) {
        if (!val) return null;
        const d = new Date(val);
        if (isNaN(d)) return null;
        return d.toISOString();
      }

      function statusBadge(status) {
        const base =
          "inline-flex items-center px-2 py-1 rounded-full text-xs font-medium";
        const map = {
          Pending: "bg-yellow-100 text-yellow-800",
          Confirmed: "bg-green-100 text-green-800",
          Completed: "bg-blue-100 text-blue-800",
          Cancelled: "bg-red-100 text-red-700",
          Rejected: "bg-red-100 text-red-700",
          Declined: "bg-red-100 text-red-700",
        };
        const cls = map[status] || "bg-gray-100 text-gray-700";
        return `<span class="${base} ${cls}">${status ?? ""}</span>`;
      }
      function applyStatusPill(el, status) {
        const classes = {
          Pending: "bg-yellow-100 text-yellow-800",
          Confirmed: "bg-green-100 text-green-800",
          Completed: "bg-blue-100 text-blue-800",
          Cancelled: "bg-red-100 text-red-700",
          Rejected: "bg-red-100 text-red-700",
          Declined: "bg-red-100 text-red-700",
        };
        el.className =
          "inline-flex items-center px-2 py-1 rounded-full text-xs font-medium " +
          (classes[status] || "bg-gray-100 text-gray-700");
        el.textContent = status ?? "—";
      }

      // ---------- Skeleton ----------
      function showTableSkeleton(rows = 8) {
        const cells = `
          <td class="px-6 py-4"><div class="h-4 w-44 rounded tg-shimmer"></div></td>
          <td class="px-6 py-4"><div class="h-4 w-40 rounded tg-shimmer"></div></td>
          <td class="px-6 py-4"><div class="h-4 w-36 rounded tg-shimmer"></div></td>
          <td class="px-6 py-4"><div class="h-4 w-20 rounded tg-shimmer"></div></td>
          <td class="px-6 py-4"><div class="h-4 w-36 rounded tg-shimmer"></div></td>
          <td class="px-6 py-4"><div class="h-5 w-24 rounded-full tg-shimmer"></div></td>`;
        tableBody.innerHTML = Array.from({ length: rows })
          .map(() => `<tr class="hover:bg-gray-50/70">${cells}</tr>`)
          .join("");
      }

      // ---------- Renderers ----------
      function renderRows(rows) {
        if (!rows || rows.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-8">
                <div class="flex items-center justify-center gap-3 text-gray-600">
                  <i data-lucide="calendar-x" class="h-5 w-5"></i>
                  <span>No bookings found</span>
                </div>
              </td>
            </tr>`;
          if (window.lucide?.createIcons) lucide.createIcons();
          return;
        }

        tableBody.innerHTML = rows
          .map(
            (b) => `
          <tr class="hover:bg-gray-50 cursor-pointer transition-colors" data-id="${
            b.id ?? ""
          }">
            <td class="px-6 py-4">
              <div class="font-medium text-gray-900">${b.userName ?? ""}</div>
              <div class="text-xs text-gray-500">${b.phoneNumber ?? ""}</div>
              <div class="text-[11px] text-gray-400">${
                b.bookingPublicId ?? ""
              }</div>
            </td>
            <td class="px-6 py-4">${b.tripName ?? ""}</td>
            <td class="px-6 py-4">${formatDateLocal(
              b.tripdate || b.tripDate
            )}</td>
            <td class="px-6 py-4">${formatMoney(b.totalCost)}</td>
            <td class="px-6 py-4">${formatDateLocal(b.createdAt)}</td>
            <td class="px-6 py-4">${statusBadge(b.status)}</td>
          </tr>
        `
          )
          .join("");

        if (window.lucide?.createIcons) lucide.createIcons();
      }

      function renderStats() {
        const start = totalCount ? (currentPage - 1) * pageSize + 1 : 0;
        const end = Math.min(currentPage * pageSize, totalCount);
        statsEl.textContent = totalCount
          ? `Showing ${start}–${end} of ${totalCount} bookings`
          : "No bookings";
      }

      function renderPagination(current, total) {
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        paginationEl.innerHTML = "";

        const group = document.createElement("div");
        group.className =
          "inline-flex overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white shadow-sm";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.disabled = current === 1 || total === 0;
        prevBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            loadBookings(currentPage);
          }
        };

        const info = document.createElement("span");
        info.className = "px-4 py-2 text-gray-600 border-x border-gray-200";
        info.textContent = `Page ${Math.min(
          current,
          totalPages
        )} of ${totalPages}`;

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = current === totalPages || total === 0;
        nextBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        nextBtn.onclick = () => {
          const tp = Math.max(1, Math.ceil(total / pageSize));
          if (currentPage < tp) {
            currentPage++;
            loadBookings(currentPage);
          }
        };

        group.appendChild(prevBtn);
        group.appendChild(info);
        group.appendChild(nextBtn);

        // Place group + stats nicely
        const left = document.createElement("div");
        left.appendChild(group);

        const right = document.createElement("div");
        right.className = "text-gray-600";
        right.textContent = total ? `${total} total` : "—";

        paginationEl.appendChild(left);
        paginationEl.appendChild(right);
      }

      // ---------- Data ----------
      function buildBookingsUrl(pageNumber, pageSize) {
        const params = new URLSearchParams();
        params.set("PageNumber", String(pageNumber));
        params.set("PageSize", String(pageSize));
        if (currentSearch) params.set("Search", currentSearch);
        if (currentStatus) params.set("BookingStatus", currentStatus);
        if (currentSort) params.set("Sort", currentSort);
        return `${ENDPOINTS.bookings}?${params.toString()}`;
      }

      async function loadBookings(pageNumber = 1) {
        try {
          loading = true;
          showTableSkeleton(pageSize);
          renderStats(); // update while we fetch
          const url = buildBookingsUrl(pageNumber, pageSize);
          const res = await authorizedFetch(url, { method: "GET" });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`Fetch failed (${res.status}) ${text}`);
          }
          const json = await res.json();
          const payload =
            json && json.data
              ? json.data
              : { pageNumber: 1, pageSize, count: 0, data: [] };

          currentPage = payload.pageNumber || pageNumber;
          totalCount = typeof payload.count === "number" ? payload.count : 0;
          pageRows = Array.isArray(payload.data) ? payload.data : [];

          renderRows(pageRows);
          renderStats();
          renderPagination(currentPage, totalCount);
        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-8 text-center">
                <div class="text-red-600 font-medium">Couldn't load bookings.</div>
                <div class="text-sm text-gray-500 mt-1">${
                  err?.message || "Unexpected error"
                }</div>
              </td>
            </tr>`;
          paginationEl.innerHTML = "";
          statsEl.textContent = "";
        } finally {
          loading = false;
        }
      }

      // ---------- Modal logic ----------
      function openModal() {
        modalRoot.classList.remove("hidden");
        document.documentElement.classList.add("overflow-hidden");
        document.body.classList.add("overflow-hidden");
        requestAnimationFrame(() => {
          modalOverlay.classList.remove("opacity-0");
          modalPanel.classList.remove("opacity-0", "translate-y-6");
          modalRoot.setAttribute("aria-hidden", "false");
        });
      }
      function closeModal() {
        if (modalBusy) return;
        modalOverlay.classList.add("opacity-0");
        modalPanel.classList.add("opacity-0", "translate-y-6");
        setTimeout(() => {
          modalRoot.classList.add("hidden");
          modalRoot.setAttribute("aria-hidden", "true");
          document.documentElement.classList.remove("overflow-hidden");
          document.body.classList.remove("overflow-hidden");
        }, 150);
      }

      function setActionBusy(busy) {
        modalBusy = busy;
        bmBtnDelete.disabled = busy || !currentModalBooking;
        bmBtnCancel.disabled = busy || !currentModalBooking;
        bmBtnConfirm.disabled =
          busy || !currentModalBooking || !isEditorValid();
        bmCloseDisabled(busy);
        [bmBtnDelete, bmBtnCancel, bmBtnConfirm].forEach((btn) => {
          if (busy) {
            btn.dataset._label = btn.innerHTML;
            btn.innerHTML = `
              <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg> Working…`;
          } else if (btn.dataset._label) {
            btn.innerHTML = btn.dataset._label;
            delete btn.dataset._label;
          }
        });
      }
      function bmCloseDisabled(disabled) {
        if (disabled) {
          modalCloseBtn.setAttribute("disabled", "true");
          modalCloseBtn.classList.add("opacity-50", "cursor-not-allowed");
        } else {
          modalCloseBtn.removeAttribute("disabled");
          modalCloseBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }
      }
      function resetModalState() {
        currentModalBooking = null;
        bmTitle.textContent = "Booking";
        bmSubtitle.textContent = "—";

        // show loader, hide error + both panes
        bmLoading.classList.remove("hidden");
        bmError.classList.add("hidden");
        bmPaneSummary.classList.add("hidden");
        bmPaneEdit.classList.add("hidden");

        // buttons & close state
        bmBtnDelete.disabled = true;
        bmBtnCancel.disabled = true;
        bmBtnConfirm.disabled = true;
        bmCloseDisabled(false);

        // clear editor inputs + validation highlights
        bmEditAdults.value = "";
        bmEditChildren.value = "";
        bmEditDatetime.value = "";
        [bmEditAdults, bmEditChildren, bmEditDatetime].forEach((el) =>
          el.classList.remove("ring-1", "ring-red-400")
        );
      }

      function setEditorValuesFromBooking(d) {
        bmEditAdults.value = Number(
          typeof d.adults === "number" ? d.adults : Number(d.adults) || 0
        );
        const children =
          (typeof d.childrens === "number"
            ? d.childrens
            : Number(d.childrens)) ||
          (typeof d.children === "number"
            ? d.children
            : Number(d.children) || 0);
        bmEditChildren.value = Number(children);
        const tripIso = d.tripdate || d.tripDate || d.trip_date;
        bmEditDatetime.value = toDatetimeLocalValue(tripIso);
      }
      function isEditorValid() {
        const a = Number(bmEditAdults.value);
        const c = Number(bmEditChildren.value);
        const dt = bmEditDatetime.value;
        const okInt = (n) => Number.isInteger(n) && n >= 0 && n <= 2147483647;
        const ok = okInt(a) && okInt(c) && !!dt;
        bmEditAdults.classList.toggle("ring-1", !okInt(a));
        bmEditAdults.classList.toggle("ring-red-400", !okInt(a));
        bmEditChildren.classList.toggle("ring-1", !okInt(c));
        bmEditChildren.classList.toggle("ring-red-400", !okInt(c));
        bmEditDatetime.classList.toggle("ring-1", !dt);
        bmEditDatetime.classList.toggle("ring-red-400", !dt);
        return ok;
      }

      async function openBookingModal(id) {
        resetModalState();
        openModal();
        try {
          const res = await authorizedFetch(ENDPOINTS.getBooking(id), {
            method: "GET",
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`(${res.status}) ${text}`);
          }
          const json = await res.json();
          const d = json?.data || json;
          currentModalBooking = d;

          bmTitle.textContent = d.tripName || "Booking";
          bmSubtitle.textContent = `#${d.bookingPublicId ?? d.id ?? ""}`;
          bmUserName.textContent = d.userName ?? "—";
          bmPhone.textContent = d.phoneNumber ?? "—";
          bmTripName.textContent = d.tripName ?? "—";
          bmTripDate.textContent = formatDateLocal(d.tripdate || d.tripDate);
          bmAdults.textContent =
            typeof d.adults === "number" ? d.adults : Number(d.adults) || 0;
          bmChildren.textContent =
            (typeof d.childrens === "number"
              ? d.childrens
              : Number(d.childrens)) ||
            (typeof d.children === "number"
              ? d.children
              : Number(d.children) || 0);
          applyStatusPill(bmStatusPill, d.status || "—");
          bmTotal.textContent = formatMoney(d.totalCost);
          bmPublicId.textContent = d.bookingPublicId ?? "—";
          bmCreated.textContent = formatDateLocal(d.createdAt);

          setEditorValuesFromBooking(d);

          // set the initial bubble letter
          const n = (d.userName || "").trim();
          bmUserInitial.textContent = n ? n.charAt(0).toUpperCase() : "?";

          // show content and default tab
          bmLoading.classList.add("hidden");
          document.getElementById("bm-error")?.classList.add("hidden");
          showBookingTab("summary"); // << new
          bmBtnDelete.disabled = false;
          bmBtnCancel.disabled = false;
          bmBtnConfirm.disabled = true; // summary tab

          if (window.lucide?.createIcons) lucide.createIcons();
        } catch (err) {
          console.error(err);
          bmLoading.classList.add("hidden");
          bmError.classList.remove("hidden");
          bmErrorMsg.textContent = err?.message || "Unexpected error.";
          bmCloseDisabled(false);
        }
      }

      async function declineBooking() {
        if (!currentModalBooking || modalBusy) return;
        if (!isEditorValid()) return;
        setActionBusy(true);
        try {
          const b = currentModalBooking;
          const payload = {
            adults: Number(bmEditAdults.value),
            children: Number(bmEditChildren.value),
            tripDate:
              datetimeLocalToISO(bmEditDatetime.value) ||
              b.tripdate ||
              b.tripDate,
            status: "Declined",
          };
          const res = await authorizedFetch(ENDPOINTS.updateBooking(b.id), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`(${res.status}) ${text}`);
          }
          applyStatusPill(bmStatusPill, "Declined");
          const idx = pageRows.findIndex((r) => String(r.id) === String(b.id));
          if (idx > -1) {
            pageRows[idx] = { ...pageRows[idx], status: "Declined" };
            renderRows(pageRows);
          }
          tgToast({ variant: "success", message: "Booking declined." });
          closeModal();
        } catch (e) {
          console.error(e);
          tgToast({ variant: "error", message: "Failed to decline booking." });
        } finally {
          setActionBusy(false);
        }
      }

      async function deleteBookingPermanently() {
        if (!currentModalBooking || modalBusy) return;
        if (!confirm("Permanently delete this booking? This cannot be undone."))
          return;
        setActionBusy(true);
        try {
          const id = currentModalBooking.id;
          const res = await authorizedFetch(ENDPOINTS.deleteBooking(id), {
            method: "DELETE",
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`(${res.status}) ${text}`);
          }
          pageRows = pageRows.filter((r) => String(r.id) !== String(id));
          totalCount = Math.max(0, totalCount - 1);
          renderRows(pageRows);
          renderStats();
          renderPagination(currentPage, totalCount);
          tgToast({ variant: "success", message: "Booking deleted." });
          closeModal();
        } catch (e) {
          console.error(e);
          tgToast({ variant: "error", message: "Failed to delete booking." });
        } finally {
          setActionBusy(false);
        }
      }

      async function confirmBooking() {
        if (!currentModalBooking || modalBusy) return;
        if (!isEditorValid()) return;
        setActionBusy(true);
        try {
          const b = currentModalBooking;
          const payload = {
            adults: Number(bmEditAdults.value),
            children: Number(bmEditChildren.value),
            tripDate:
              datetimeLocalToISO(bmEditDatetime.value) ||
              b.tripdate ||
              b.tripDate,
            status: "Confirmed",
          };
          const res = await authorizedFetch(ENDPOINTS.updateBooking(b.id), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`(${res.status}) ${text}`);
          }
          applyStatusPill(bmStatusPill, "Confirmed");
          const idx = pageRows.findIndex((r) => String(r.id) === String(b.id));
          if (idx > -1) {
            pageRows[idx] = {
              ...pageRows[idx],
              status: "Confirmed",
              adults: payload.adults,
              childrens: payload.children,
              tripDate: payload.tripDate,
              tripdate: payload.tripDate,
            };
            renderRows(pageRows);
          }
          tgToast({ variant: "success", message: "Booking confirmed." });
          closeModal();
        } catch (e) {
          console.error(e);
          tgToast({ variant: "error", message: "Failed to confirm booking." });
        } finally {
          setActionBusy(false);
        }
      }

      // ---------- Utils ----------
      function debounce(fn, delay = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(null, args), delay);
        };
      }

      function setupHeaderSort() {
        document.querySelectorAll("thead [data-sort]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.sort; // "createdat" or "tripdate"
            const current = sortSelect.value;
            const asc = `${key}:asc`;
            const desc = `${key}:desc`;
            const next = current === asc ? desc : asc;
            sortSelect.value = next;
            sortSelect.dispatchEvent(new Event("change"));
            // update badges
            document
              .querySelectorAll(".sort-badge")
              .forEach((b) => b.classList.add("hidden"));
            const badge = btn.querySelector(".sort-badge");
            if (badge) {
              badge.textContent = next.endsWith(":asc") ? "▲" : "▼";
              badge.classList.remove("hidden");
            }
          });
        });
      }

      // ---------- Boot ----------
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide?.createIcons) lucide.createIcons();

        loadBookings(currentPage);

        const onSearch = debounce(() => {
          currentSearch = (searchInput.value || "").trim();
          currentPage = 1;
          loadBookings(currentPage);
        }, 350);
        searchInput.addEventListener("input", onSearch);

        statusFilter.addEventListener("change", () => {
          currentStatus = statusFilter.value;
          currentPage = 1;
          loadBookings(currentPage);
        });

        sortSelect.addEventListener("change", () => {
          currentSort = sortSelect.value;
          currentPage = 1;
          // update header badges UI
          document.querySelectorAll("thead [data-sort]").forEach((btn) => {
            const key = btn.dataset.sort;
            const badge = btn.querySelector(".sort-badge");
            if (!badge) return;
            const isThis = currentSort.startsWith(`${key}:`);
            badge.classList.toggle("hidden", !isThis);
            if (isThis)
              badge.textContent = currentSort.endsWith(":asc") ? "▲" : "▼";
          });
          loadBookings(currentPage);
        });

        refreshBtn.addEventListener("click", () => loadBookings(currentPage));

        // Row click -> open modal
        tableBody.addEventListener("click", (e) => {
          const tr = e.target.closest("tr[data-id]");
          if (!tr) return;
          const id = tr.getAttribute("data-id");
          if (!id) return;
          openBookingModal(id);
        });

        // Modal events
        modalOverlay.addEventListener("click", () => closeModal());
        modalCloseBtn.addEventListener("click", () => closeModal());
        document.addEventListener("keydown", (e) => {
          if (
            e.key === "Escape" &&
            !modalBusy &&
            !modalRoot.classList.contains("hidden")
          ) {
            closeModal();
          }
        });
        bmBtnDelete.addEventListener("click", deleteBookingPermanently);
        bmBtnCancel.addEventListener("click", declineBooking);
        bmBtnConfirm.addEventListener("click", confirmBooking);

        // Live validation for editor
        [bmEditAdults, bmEditChildren, bmEditDatetime].forEach((el) => {
          el.addEventListener("input", () => {
            if (!currentModalBooking) return;
            const onEditTab =
              bmPaneEdit && !bmPaneEdit.classList.contains("hidden");
            bmBtnConfirm.disabled = !onEditTab || !isEditorValid() || modalBusy;
          });
        });

        setupHeaderSort();
      });
    </script>
    <script src="../js/logout.js" defer></script>
  </body>
</html>
