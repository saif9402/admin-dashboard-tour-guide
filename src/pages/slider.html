<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html[data-auth="checking"] body {
        visibility: hidden;
      }

      /* tiny helper for shimmering */
      .tg-shimmer {
        position: relative;
        overflow: hidden;
        background: #e5e7eb;
      }
      .tg-shimmer::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.6),
          transparent
        );
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }
    </style>

    <script>
      document.documentElement.setAttribute("data-auth", "checking");
    </script>

    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script
      src="../js/auth-guard.js"
      defer
      data-redirect="../index.html"
    ></script>

    <title>Tour Guide Admin Panel</title>
  </head>

  <body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r shadow-md">
        <div class="flex items-center border-b justify-center h-20">
          <img
            src="../img/Header.svg"
            alt="logo header"
            class="h-96 object-contain flex items-start justify-start"
          />
        </div>
        <nav class="p-4 space-y-3">
          <a
            href="home.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="map"></i> <span>Trips</span>
          </a>
          <a
            href="categories.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="folder"></i> <span>Categories</span>
          </a>
          <a
            href="includes.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="check-square"></i> <span>Includes</span>
          </a>
          <a
            href="Languages.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="languages"></i> <span>Languages</span>
          </a>
          <a
            href="activities.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="activity"></i> <span>Activities</span>
          </a>
          <a
            href="booking.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="calendar-check"></i> <span>Bookings</span>
          </a>
          <a
            href="slider.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 bg-blue-100 shadow-inner font-medium"
          >
            <i data-lucide="image"></i> <span>Slider Images</span>
          </a>
          <a
            href="#"
            id="logoutBtn"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-100"
          >
            <i data-lucide="log-out"></i> <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
        >
          <h1 class="text-3xl font-bold text-gray-900">Manage Slider Images</h1>
          <div class="flex items-center gap-2">
            <button
              id="addImageBtn"
              class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow"
            >
              <i data-lucide="plus"></i> Add Image
            </button>
          </div>
        </div>

        <!-- Card -->
        <div
          class="bg-white rounded-2xl shadow ring-1 ring-gray-200 overflow-hidden"
        >
          <div
            class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b"
          >
            <div class="text-sm text-gray-600">Images</div>
          </div>

          <!-- Grid -->
          <div class="p-4">
            <div
              id="grid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
            ></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay -->
    <div
      id="sheetOverlay"
      class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity"
    ></div>

    <!-- Side Sheet: Add Image (File only) -->
    <div
      id="imageSheet"
      class="fixed top-0 right-0 z-50 h-full w-full max-w-md bg-white shadow-2xl ring-1 ring-black/5 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="sheetTitle"
    >
      <div class="flex flex-col h-full">
        <!-- header -->
        <div
          class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white"
        >
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span
                class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/10 ring-1 ring-white/20"
              >
                <i data-lucide="image" class="h-5 w-5"></i>
              </span>
              <h2 id="sheetTitle" class="text-lg font-semibold tracking-tight">
                Add Image
              </h2>
            </div>
            <button
              type="button"
              class="btn-cancel rounded-xl p-2 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40"
              aria-label="Close"
            >
              <i data-lucide="x" class="h-5 w-5"></i>
            </button>
          </div>
        </div>

        <!-- body -->
        <form
          id="imageForm"
          class="flex-1 overflow-y-auto custom-scroll p-6 space-y-5"
        >
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700"
              >Select images</label
            >
            <input
              type="file"
              id="imageFile"
              name="Images"
              accept="image/*"
              multiple
              class="w-full rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm"
            />
            <div
              id="preview"
              class="rounded-xl overflow-hidden ring-1 ring-gray-200"
            >
              <div
                class="aspect-[16/9] bg-gray-100 flex items-center justify-center"
              >
                <span class="text-gray-400 text-sm">Preview</span>
              </div>
            </div>
          </div>
        </form>

        <!-- footer -->
        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
          <button
            type="button"
            class="btn-cancel px-5 py-2.5 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium shadow-sm"
          >
            Cancel
          </button>
          <button
            type="submit"
            form="imageForm"
            class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <script src="../js/logout.js" defer></script>

    <script>
      // ------- helpers -------
      const $ = (id) => document.getElementById(id);

      const FALLBACK_DATA_IMG =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          "<svg xmlns='http://www.w3.org/2000/svg' width='1600' height='900'>" +
            "<defs><linearGradient id='g' x1='0' x2='1'><stop offset='0%' stop-color='#f3f4f6'/>" +
            "<stop offset='50%' stop-color='#e5e7eb'/><stop offset='100%' stop-color='#f3f4f6'/></linearGradient></defs>" +
            "<rect width='100%' height='100%' fill='url(#g)'/>" +
            "<text x='50%' y='50%' text-anchor='middle' dominant-baseline='middle' font-size='36' fill='#9ca3af' font-family='system-ui,Segoe UI,Roboto'>No image</text></svg>"
        );

      function toast(msg, variant = "info") {
        if (typeof tgToast === "function") tgToast({ variant, message: msg });
        else alert(msg);
      }

      async function addImagesFromFiles(fileList) {
        if (!fileList || fileList.length === 0)
          throw new Error("No files selected.");

        const fd = new FormData();
        Array.from(fileList).forEach((file) => fd.append("Images", file));

        const res = await fetch("/api/SliderImages/AddImagesToSlider", {
          method: "POST",
          body: fd,
        });
        const text = await res.text(); // API returns text/plain
        if (!res.ok) throw new Error(text || "Upload failed.");
        return text;
      }

      async function apiDeleteImages(ids) {
        if (!Array.isArray(ids) || ids.length === 0)
          throw new Error("No image ids.");
        const fd = new FormData();
        ids.forEach((id) => fd.append("ImagesIds", String(id)));

        const res = await fetch("/api/SliderImages/DeleteImagesFromSlider", {
          method: "DELETE",
          body: fd,
        });

        const text = await res.text(); // API returns text/plain
        if (!res.ok) throw new Error(text || "Delete failed.");
        return text;
      }

      // ------- state -------
      let allImages = []; // { id, imageURL }[]

      // ------- UI elements -------
      const grid = $("grid");
      const overlay = $("sheetOverlay");
      const sheet = $("imageSheet");
      const form = $("imageForm");
      const fileInput = $("imageFile");
      const preview = $("preview");

      // ------- skeleton -------
      function showSkeleton(rows = 8) {
        grid.innerHTML = "";
        for (let i = 0; i < rows; i++) {
          const sk = document.createElement("div");
          sk.className =
            "rounded-2xl overflow-hidden ring-1 ring-gray-200 bg-white";
          sk.innerHTML = `
            <div class="aspect-[16/9] tg-shimmer"></div>
            <div class="p-4 space-y-2">
              <div class="h-3 w-2/3 rounded tg-shimmer"></div>
              <div class="h-8 w-24 rounded-lg tg-shimmer"></div>
            </div>`;
          grid.appendChild(sk);
        }
      }

      // ------- fetch + render -------
      async function fetchImages() {
        try {
          showSkeleton();
          const res = await fetch("/api/SliderImages/GetSliderImages");
          const data = await res.json();

          if (!res.ok || !data?.succeeded) {
            throw new Error(data?.message || "Failed to load images");
          }

          allImages = Array.isArray(data.data) ? data.data : [];
          renderGrid(allImages);
        } catch (err) {
          console.error(err);
          grid.innerHTML = `
            <div class="col-span-full">
              <div class="px-6 py-12 text-center text-red-500">Failed to load slider images.</div>
            </div>`;
          toast("Failed to load images.", "error");
        } finally {
          if (window.lucide?.createIcons) lucide.createIcons();
        }
      }

      function renderGrid(items) {
        grid.innerHTML = "";

        if (!items.length) {
          grid.innerHTML = `
            <div class="col-span-full">
              <div class="flex items-center justify-center gap-3 text-gray-600 py-12">
                <i data-lucide="image" class="h-5 w-5"></i>
                <span>No images found</span>
                <button id="quickAdd" class="ml-3 inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-1.5 text-white text-xs font-semibold hover:bg-blue-700">
                  <i data-lucide="plus" class="h-4 w-4"></i> Add Image
                </button>
              </div>
            </div>`;
          if (window.lucide?.createIcons) lucide.createIcons();
          const qa = $("quickAdd");
          if (qa) qa.addEventListener("click", openAddSheet);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className =
            "group bg-white rounded-2xl ring-1 ring-gray-200 overflow-hidden shadow-sm hover:shadow-md transition";

          const safeURL = item.imageURL || "";
          const idBadge = `<span class="absolute left-2 top-2 inline-flex items-center justify-center h-7 rounded-lg bg-black/60 text-white px-2 text-xs ring-1 ring-white/30 tabular-nums">#${item.id}</span>`;
          const actions = `
            <div class="absolute right-2 top-2 hidden group-hover:flex gap-1">
              <a href="${safeURL}" target="_blank" rel="noopener" title="Open" class="p-2 rounded-lg bg-white/90 hover:bg-white ring-1 ring-gray-200 shadow-sm">
                <i data-lucide="external-link" class="h-4 w-4"></i>
              </a>
              <button title="Copy URL" class="p-2 rounded-lg bg-white/90 hover:bg-white ring-1 ring-gray-200 shadow-sm"
                      onclick="copyURL('${encodeURIComponent(
                        safeURL
                      )}'); return false;">
                <i data-lucide="copy" class="h-4 w-4"></i>
              </button>
            </div>`;

          card.innerHTML = `
            <div class="relative aspect-[16/9] bg-gray-100 overflow-hidden">
              <img src="${safeURL}" alt="slider image ${
            item.id
          }" class="h-full w-full object-cover"
                   onerror="this.src='${FALLBACK_DATA_IMG}'" />
              ${idBadge}
              ${actions}
              <div class="absolute bottom-2 right-2 hidden group-hover:block">
                <button
                    class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-medium shadow"
                    onclick="deleteSliderImage(${item.id}, this)">
                    <i data-lucide="trash-2" class="h-4 w-4"></i> Delete
                </button>

              </div>
            </div>
            <div class="px-4 py-3 flex items-center justify-between gap-3">
              <div class="truncate text-gray-700 text-xs" title="${safeURL}">${safeURL}</div>
              <button class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-white ring-1 ring-gray-200 hover:bg-gray-50 text-gray-700 text-xs shadow-sm"
                      onclick="copyURL('${encodeURIComponent(safeURL)}')">
                <i data-lucide="clipboard" class="h-4 w-4"></i> Copy
              </button>
            </div>`;
          grid.appendChild(card);
        });

        if (window.lucide?.createIcons) lucide.createIcons();
      }

      // ------- actions -------
      window.copyURL = async function (encoded) {
        const url = decodeURIComponent(encoded || "");
        try {
          await navigator.clipboard.writeText(url);
          toast("Image URL copied.", "success");
        } catch {
          toast("Failed to copy.", "error");
        }
      };

      window.deleteSliderImage = async function (id, btnEl) {
        const ok = confirm(`Delete image #${id}?`);
        if (!ok) return;

        // disable the clicked button while deleting
        if (btnEl) {
          btnEl.disabled = true;
          btnEl.classList.add("opacity-60", "cursor-not-allowed");
        }

        try {
          await apiDeleteImages([id]);
          toast("Image deleted.", "success");

          // Optimistic UI: remove the card locally and re-render
          allImages = allImages.filter((x) => x.id !== id);
          // remove card from DOM if we have the button element
          const card = btnEl?.closest(".group");
          if (card) card.remove();

          // If you prefer a full refresh instead, uncomment:
          // await fetchImages();
        } catch (err) {
          console.error(err);
          toast(err.message || "Failed to delete image.", "error");
        } finally {
          if (btnEl) {
            btnEl.disabled = false;
            btnEl.classList.remove("opacity-60", "cursor-not-allowed");
          }
        }
      };

      // ------- sheet/overlay -------
      let lastFocused = null;
      function openAddSheet() {
        openSheet("Add Image");
        fileInput?.focus();
      }

      function openSheet(titleText) {
        $("sheetTitle").textContent = titleText || "Add Image";
        lastFocused = document.activeElement;
        overlay.classList.remove("hidden");
        sheet.classList.remove("hidden");
        requestAnimationFrame(() => overlay.classList.remove("opacity-0"));
        document.addEventListener("keydown", onEscClose);
      }
      function closeSheet() {
        overlay.classList.add("opacity-0");
        setTimeout(() => {
          overlay.classList.add("hidden");
          sheet.classList.add("hidden");
          if (lastFocused) lastFocused.focus();
        }, 200);
        document.removeEventListener("keydown", onEscClose);
      }
      function onEscClose(e) {
        if (e.key === "Escape") closeSheet();
      }
      overlay.addEventListener("click", closeSheet);
      document.addEventListener("click", (e) => {
        if (e.target.closest(".btn-cancel")) closeSheet();
      });

      // ------- preview -------
      function updatePreview() {
        const files = fileInput.files;
        let src = "";
        if (files && files.length) {
          const first = files[0];
          if (files.length > 1) {
            preview.innerHTML = `
              <div class="p-4 text-sm text-gray-600 border-b">Selected ${
                files.length
              } files. First shown below.</div>
              <img src="${URL.createObjectURL(
                first
              )}" class="w-full h-auto object-cover aspect-[16/9]" />`;
            return;
          }
          src = URL.createObjectURL(first);
        }
        if (!src) {
          preview.innerHTML = `
            <div class="aspect-[16/9] bg-gray-100 flex items-center justify-center">
              <span class="text-gray-400 text-sm">Preview</span>
            </div>`;
          return;
        }
        preview.innerHTML = `<img src="${src}" alt="preview" class="w-full h-auto object-cover aspect-[16/9]" onerror="this.src='${FALLBACK_DATA_IMG}'" />`;
      }
      fileInput.addEventListener("change", updatePreview);

      // ------- form submit -------
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const saveBtn = sheet.querySelector(
          'button[type="submit"][form="imageForm"]'
        );
        saveBtn.disabled = true;
        saveBtn.classList.add("opacity-50", "cursor-not-allowed");

        try {
          const files = fileInput.files;
          if (!files || files.length === 0)
            throw new Error("Please choose at least one file.");
          await addImagesFromFiles(files);

          toast("Image(s) added to slider.", "success");
          closeSheet();
          form.reset();
          updatePreview();
          await fetchImages(); // refresh grid
        } catch (err) {
          console.error(err);
          toast(err.message || "Failed to add images.", "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }
      });

      // header action
      $("addImageBtn").addEventListener("click", openAddSheet);

      // boot
      function boot() {
        if (window.lucide?.createIcons) lucide.createIcons();
        fetchImages();
      }
      if (document.documentElement.getAttribute("data-auth") === "ready")
        boot();
      else document.addEventListener("auth:ready", boot, { once: true });
    </script>
  </body>
</html>
