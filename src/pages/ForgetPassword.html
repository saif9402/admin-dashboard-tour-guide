<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Forgot Password | Tour Guide</title>

    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Page content -->

    <div class="bg-white shadow-2xl rounded-2xl w-full max-w-md p-8">
      <div class="flex items-center justify-center h-9 md:h-12">
        <img
          src="../img/Header.svg"
          alt="logo header"
          class="h-70 object-contain flex items-start justify-start"
        />
      </div>

      <h1 class="text-2xl mt-5 font-bold text-center text-gray-800">
        Forgot your password?
      </h1>
      <p class="mt-2 text-center text-gray-500 text-sm">
        Enter your email and we’ll send you a reset link.
      </p>

      <!-- Form -->
      <form id="resetForm" class="mt-6 space-y-4" novalidate>
        <div>
          <label class="block text-sm text-gray-600 mb-1" for="email"
            >Email</label
          >
          <input
            id="email"
            type="email"
            placeholder="you@example.com"
            autocomplete="email"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"
            required
          />
        </div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg shadow-md transition disabled:opacity-60 disabled:cursor-not-allowed"
        >
          Send Reset Link
        </button>

        <p class="text-center text-sm text-gray-500">
          <span>Remembered it?</span>
          <a href="../index.html" class="text-blue-600 hover:underline">
            Back to sign in
          </a>
        </p>

        <p class="text-xs text-gray-400 text-center mt-2">
          Tip: Check your spam/junk folder if you don’t see the email.
        </p>
      </form>

      <p class="text-center text-xs text-gray-400 mt-6">
        <span id="copyYear"></span>
        <span>Tour Guide. All rights reserved.</span>
      </p>
    </div>

    <!-- Page behavior -->
    <script>
      // Lightweight toast (uses your global showToast if present)
      function toast(message, type = "success") {
        if (window.showToast) return showToast(message, type);
        const wrap = document.getElementById("toast-container");
        const el = document.createElement("div");
        el.className = `
          max-w-sm w-full px-4 py-3 rounded-lg shadow-lg text-white transition
          ${type === "success" ? "bg-green-600" : "bg-red-600"}
        `;
        el.textContent = message;
        wrap.appendChild(el);
        setTimeout(() => {
          el.style.opacity = "0";
          el.style.transform = "translateY(-4px)";
          el.addEventListener("transitionend", () => el.remove());
        }, 3500);
      }

      (function () {
        const t = (k, p) =>
          typeof window.t === "function"
            ? window.t(k, p)
            : k.replace(/\{(\w+)\}/g, (_, m) =>
                p && p[m] != null ? p[m] : `{${m}}`
              );

        // Footer year
        const y = new Date().getFullYear();
        const copyYear = document.getElementById("copyYear");
        if (copyYear) copyYear.textContent = `© ${y} `;

        const form = document.getElementById("resetForm");
        const emailInput = document.getElementById("email");
        const submitBtn = document.getElementById("submitBtn");

        // Cooldown to avoid spam
        let cooldownTimer = null;
        function startCooldown(seconds = 30) {
          let remain = seconds;
          submitBtn.disabled = true;
          const base = t("forgot.cooldown", { s: remain }); // "Resend in {s}s"
          submitBtn.textContent = base;
          cooldownTimer = setInterval(() => {
            remain -= 1;
            if (remain <= 0) {
              clearInterval(cooldownTimer);
              submitBtn.disabled = false;
              submitBtn.textContent = t("forgot.submit");
            } else {
              submitBtn.textContent = t("forgot.cooldown", { s: remain });
            }
          }, 1000);
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = (emailInput.value || "").trim();
          if (!email) {
            emailInput.focus();
            return toast(t("forgot.error.noEmail"), "error");
          }

          // Basic client-side email check
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!emailOk) {
            emailInput.focus();
            return toast(t("forgot.error.invalidEmail"), "error");
          }

          const original = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = t("forgot.sending"); // "Sending…"

          try {
            const res = await fetch("/api/Auth/ForgetPassword", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            let data = {};
            try {
              data = await res.json();
            } catch {}

            if (res.ok) {
              // Security-friendly: never reveal whether an email exists
              toast(t("forgot.successGeneric"), "success");
              form.reset();
              startCooldown(30);
            } else {
              toast(
                data?.errors?.join(", ") || t("forgot.error.generic"),
                "error"
              );
              submitBtn.disabled = false;
              submitBtn.textContent = original;
            }
          } catch (err) {
            console.error(err);
            toast(t("forgot.error.network"), "error");
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          }
        });

        // Keep <title> updated after language switch
        function setPageTitle() {
          if (typeof window.t === "function") {
            document.title = window.t("forgot.pageTitle") || document.title;
          }
        }
        document.addEventListener("DOMContentLoaded", setPageTitle);
        const prev = window.refreshLangData;
        window.refreshLangData = async function (...args) {
          const out = await prev?.apply(this, args);
          setPageTitle();
          return out;
        };
      })();
    </script>
  </body>
</html>
