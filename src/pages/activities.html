<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Tour Guide Admin Panel</title>
  </head>

  <body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r shadow-md">
        <div class="flex items-center border-b justify-center h-20">
          <img
            src="../img/Header.svg"
            alt="logo header"
            class="h-96 object-contain flex items-start justify-start"
          />
        </div>
        <nav class="p-4 space-y-3">
          <a
            href="home.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="map"></i> <span>Trips</span>
          </a>
          <a
            href="categories.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="folder"></i> <span>Categories</span>
          </a>
          <a
            href="includes.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="check-square"></i> <span>Includes</span>
          </a>
          <a
            href="Languages.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="languages"></i> <span>Languages</span>
          </a>
          <a
            href="activities.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 bg-blue-100 shadow-inner font-medium"
          >
            <i data-lucide="activity"></i> <span>Activities</span>
          </a>
          <a
            href="booking.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="calendar-check"></i> <span>Bookings</span>
          </a>
          <a
            href="#"
            id="logoutBtn"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-100"
          >
            <i data-lucide="log-out"></i> <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
        >
          <h1 class="text-3xl font-bold text-gray-900">Manage Activities</h1>
          <button
            id="addActivityBtn"
            class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow"
          >
            <i data-lucide="plus"></i>
            Add Activity
          </button>
        </div>

        <!-- Filters row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Search -->
          <div class="col-span-2">
            <label for="searchInput" class="sr-only">Search Activity</label>
            <div class="relative">
              <i
                data-lucide="search"
                class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"
              ></i>
              <input
                id="searchInput"
                type="text"
                placeholder="Search Activity..."
                class="w-full border border-gray-200 rounded-xl pl-10 pr-4 py-2.5 bg-white shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              />
            </div>
          </div>

          <!-- Language filter -->
          <div>
            <label
              for="languageSelect"
              class="block mb-1 text-sm font-medium text-gray-700"
              >Filter by Language</label
            >
            <select
              title="Select Language"
              id="languageSelect"
              class="w-full rounded-xl border border-gray-200 bg-white px-4 py-2.5 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
            ></select>
          </div>
        </div>

        <!-- Table Card -->
        <div
          class="bg-white rounded-2xl shadow ring-1 ring-gray-200 overflow-hidden"
        >
          <div
            class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b"
          >
            <div class="text-sm text-gray-600">Activities</div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead
                class="sticky top-0 z-10 bg-gray-50/95 backdrop-blur supports-[backdrop-filter]:bg-gray-50/75 text-gray-600 text-xs uppercase"
              >
                <tr>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="id"
                    >
                      <span>ID</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    <button
                      class="flex items-center gap-1 group"
                      data-sort="name"
                    >
                      <span>Activity</span>
                      <span
                        class="ml-1 text-[10px] px-1 rounded bg-gray-200/70 text-gray-600 sort-badge hidden"
                        >▲</span
                      >
                    </button>
                  </th>
                  <th class="px-6 py-3 text-left font-semibold tracking-wide">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody
                id="activityTable"
                class="divide-y divide-gray-100 bg-white"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div
          id="pagination"
          class="mt-6 flex justify-center items-center gap-3 text-sm font-medium"
        ></div>
      </main>
    </div>

    <!-- Overlay -->
    <div
      id="sheetOverlay"
      class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity"
    ></div>

    <!-- Side Sheet -->
    <div
      id="activitySheet"
      class="fixed top-0 right-0 z-50 h-full w-full max-w-md bg-white shadow-2xl ring-1 ring-black/5 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="sheetTitle"
    >
      <div class="flex flex-col h-full">
        <!-- sheet header -->
        <div
          class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white"
        >
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span
                class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/10 ring-1 ring-white/20"
              >
                <i data-lucide="activity" class="h-5 w-5"></i>
              </span>
              <h2 id="sheetTitle" class="text-lg font-semibold tracking-tight">
                Add Activity
              </h2>
            </div>
            <button
              type="button"
              class="btn-cancel rounded-xl p-2 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40"
              aria-label="Close"
            >
              <i data-lucide="x" class="h-5 w-5"></i>
            </button>
          </div>
        </div>

        <!-- sheet body -->
        <form
          id="activityForm"
          class="flex-1 overflow-y-auto custom-scroll p-6 space-y-5"
        >
          <input type="hidden" id="activityId" name="id" />
          <div id="languageFields" class="flex flex-col gap-4"></div>
        </form>

        <!-- sheet footer -->
        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
          <button
            type="button"
            class="btn-cancel px-5 py-2.5 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium shadow-sm"
          >
            Cancel
          </button>
          <button
            type="submit"
            form="activityForm"
            class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide?.createIcons) lucide.createIcons();
      });

      // Elements
      const sheet = document.getElementById("activitySheet");
      const overlay = document.getElementById("sheetOverlay");
      const sheetTitle = document.getElementById("sheetTitle");
      const form = document.getElementById("activityForm");
      const tableBody = document.getElementById("activityTable");
      const searchInput = document.getElementById("searchInput");
      const languageSelect = document.getElementById("languageSelect");

      // State
      let currentPage = 1;
      const pageSize = 8;
      let selectedLanguageId = "";
      let availableLanguages = [];
      let lastPageItems = [];
      let sortState = { key: null, dir: "asc" }; // id | name

      // ===== UI helpers =====
      function showSkeleton(rows = 8) {
        let html = "";
        for (let i = 0; i < rows; i++) {
          html += `
            <tr class="hover:bg-gray-50/70">
              <td class="px-6 py-4"><div class="h-4 w-16 rounded tg-shimmer"></div></td>
              <td class="px-6 py-4"><div class="h-4 w-40 rounded tg-shimmer"></div></td>
              <td class="px-6 py-4"><div class="h-8 w-24 rounded-lg tg-shimmer"></div></td>
            </tr>`;
        }
        tableBody.innerHTML = html;
      }

      function actionButtons(id) {
        return `
          <div class="inline-flex overflow-hidden rounded-lg ring-1 ring-gray-200 bg-white shadow-sm">
            <button class="px-2.5 py-2 text-blue-600 hover:bg-blue-50" title="Edit" onclick="editActivity(${id})">
              <i data-lucide="pencil" class="h-4 w-4"></i>
            </button>
            <div class="w-px bg-gray-200"></div>
            <button class="px-2.5 py-2 text-rose-600 hover:bg-rose-50" title="Delete" onclick="deleteActivity(${id})">
              <i data-lucide="trash-2" class="h-4 w-4"></i>
            </button>
          </div>
        `;
      }

      // ===== Sorting (client-side on the current page) =====
      function applySort(items) {
        if (!Array.isArray(items) || !sortState.key) return items || [];
        const dir = sortState.dir === "desc" ? -1 : 1;
        const key = sortState.key;
        return [...items].sort((a, b) => {
          let va = a[key];
          let vb = b[key];
          if (key === "id") {
            va = Number(va);
            vb = Number(vb);
          }
          va = (va ?? "").toString().toLowerCase();
          vb = (vb ?? "").toString().toLowerCase();
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return 0;
        });
      }

      function setupTableSort() {
        document.querySelectorAll("thead [data-sort]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.sort;
            if (!key) return;
            if (sortState.key === key) {
              sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
            } else {
              sortState.key = key;
              sortState.dir = "asc";
            }
            updateSortBadges();
            renderTable(lastPageItems); // re-render current page
          });
        });
      }

      function updateSortBadges() {
        document.querySelectorAll("thead [data-sort]").forEach((btn) => {
          const badge = btn.querySelector(".sort-badge");
          if (!badge) return;
          const active = sortState.key === btn.dataset.sort;
          badge.classList.toggle("hidden", !active);
          if (active) badge.textContent = sortState.dir === "asc" ? "▲" : "▼";
        });
      }

      // ===== Overlay/Sheet (slide-in) with focus trap =====
      let lastFocused = null;
      function openSheet(titleText) {
        sheetTitle.textContent = titleText || "Add Activity";
        lastFocused = document.activeElement;

        overlay.classList.remove("hidden");
        sheet.classList.remove("hidden");
        // animate in
        overlay.classList.remove("opacity-0");
        sheet.classList.add("sheet-enter");
        requestAnimationFrame(() => sheet.classList.add("sheet-enter-active"));
        setTimeout(
          () => sheet.classList.remove("sheet-enter", "sheet-enter-active"),
          300
        );

        // focus first field soon after open
        setTimeout(() => {
          const first = sheet.querySelector(
            "input, select, textarea, button:not(.btn-cancel)"
          );
          if (first) first.focus();
        }, 50);

        document.addEventListener("keydown", onEscClose);
        document.addEventListener("keydown", trapTab);
      }

      function closeSheet() {
        // animate out
        sheet.classList.add("sheet-exit");
        requestAnimationFrame(() => sheet.classList.add("sheet-exit-active"));
        overlay.classList.add("opacity-0");
        setTimeout(() => {
          sheet.classList.add("hidden");
          sheet.classList.remove("sheet-exit", "sheet-exit-active");
          overlay.classList.add("hidden");
          if (lastFocused) lastFocused.focus();
        }, 250);

        document.removeEventListener("keydown", onEscClose);
        document.removeEventListener("keydown", trapTab);
      }

      function onEscClose(e) {
        if (e.key === "Escape") closeSheet();
      }
      function trapTab(e) {
        if (e.key !== "Tab") return;
        const focusables = sheet.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          last.focus();
          e.preventDefault();
        } else if (!e.shiftKey && document.activeElement === last) {
          first.focus();
          e.preventDefault();
        }
      }

      // overlay click to close
      overlay.addEventListener("click", closeSheet);
      // cancel buttons
      document.addEventListener("click", (e) => {
        if (e.target.closest(".btn-cancel")) closeSheet();
      });

      // ===== API: Languages =====
      async function fetchLanguages() {
        try {
          const res = await fetch("/api/Language/GetAllLanguages");
          const data = await res.json();

          if (res.ok && data.succeeded) {
            availableLanguages = data.data || [];

            // Populate filter dropdown
            languageSelect.innerHTML = "";
            availableLanguages.forEach((lang) => {
              const option = document.createElement("option");
              option.value = lang.id;
              option.textContent = lang.name;
              languageSelect.appendChild(option);
            });

            // Default to English or first
            const english = availableLanguages.find(
              (l) => (l.name || "").toLowerCase() === "english"
            );
            selectedLanguageId = english?.id ?? availableLanguages[0]?.id ?? "";
            if (selectedLanguageId) languageSelect.value = selectedLanguageId;

            await loadActivity(searchInput.value.trim(), currentPage);
          } else {
            console.error("Failed to fetch languages");
          }
        } catch (err) {
          console.error("Error fetching languages:", err);
        }
      }

      // ===== API: Activities =====
      async function loadActivity(searchQuery = "", pageNumber = 1) {
        try {
          showSkeleton();
          let url = `/api/Activity/GetAllActivities/${selectedLanguageId}?pageNumber=${pageNumber}&pageSize=${pageSize}`;
          if (searchQuery) url += `&Search=${encodeURIComponent(searchQuery)}`;

          const res = await fetch(url);
          const data = await res.json();

          if (res.ok && data.succeeded) {
            const activities = data.data?.data || [];
            lastPageItems = activities.map((a) => ({ id: a.id, name: a.name }));
            renderTable(lastPageItems);
            renderPagination(data.data.pageNumber, data.data.count);
          } else {
            tableBody.innerHTML = `
              <tr>
                <td colspan="3" class="px-6 py-8 text-center text-red-500">Failed to load activities</td>
              </tr>`;
          }
        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `
            <tr>
              <td colspan="3" class="px-6 py-8 text-center text-red-500">Error loading activities</td>
            </tr>`;
        }
      }

      function renderTable(items) {
        const sorted = applySort(items);
        tableBody.innerHTML = "";

        if (!sorted || !sorted.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="3" class="px-6 py-12">
                <div class="flex items-center justify-center gap-3 text-gray-600">
                  <i data-lucide="activity" class="h-5 w-5"></i>
                  <span>No activities found</span>
                  <button id="quickAdd" class="ml-3 inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-1.5 text-white text-xs font-semibold hover:bg-blue-700">
                    <i data-lucide="plus" class="h-4 w-4"></i> Add Activity
                  </button>
                </div>
              </td>
            </tr>`;
          if (window.lucide?.createIcons) lucide.createIcons();
          const quickAdd = document.getElementById("quickAdd");
          if (quickAdd) quickAdd.addEventListener("click", onAddActivityClick);
          return;
        }

        sorted.forEach((act) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 transition-colors";
          tr.innerHTML = `
            <td class="px-6 py-4">
              <span class="inline-flex items-center justify-center h-7 w-10 rounded-lg bg-indigo-600/10 text-indigo-700 ring-1 ring-indigo-200 tabular-nums font-semibold">${
                act.id
              }</span>
            </td>
            <td class="px-6 py-4">
              <div class="font-medium text-gray-900">${act.name}</div>
            </td>
            <td class="px-6 py-4">
              ${actionButtons(act.id)}
            </td>
          `;
          tableBody.appendChild(tr);
        });

        if (window.lucide?.createIcons) lucide.createIcons();
      }

      function renderPagination(current, totalCount) {
        const container = document.getElementById("pagination");
        const totalPages = Math.ceil(totalCount / pageSize);
        container.innerHTML = "";

        const group = document.createElement("div");
        group.className =
          "inline-flex overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white shadow-sm";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.disabled = current === 1;
        prevBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        prevBtn.onclick = () => {
          if (current > 1) {
            currentPage--;
            loadActivity(searchInput.value.trim(), currentPage);
          }
        };

        const info = document.createElement("span");
        info.className = "px-4 py-2 text-gray-600 border-x border-gray-200";
        info.textContent = `Page ${current} of ${totalPages}`;

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = current === totalPages;
        nextBtn.className = "px-4 py-2 disabled:opacity-50 hover:bg-gray-50";
        nextBtn.onclick = () => {
          if (current < totalPages) {
            currentPage++;
            loadActivity(searchInput.value.trim(), currentPage);
          }
        };

        group.appendChild(prevBtn);
        group.appendChild(info);
        group.appendChild(nextBtn);
        container.appendChild(group);
      }

      // ===== Handlers =====
      languageSelect.addEventListener("change", () => {
        selectedLanguageId = languageSelect.value;
        currentPage = 1;
        loadActivity(searchInput.value.trim(), currentPage);
      });

      searchInput.addEventListener("input", () => {
        currentPage = 1;
        loadActivity(searchInput.value.trim(), currentPage);
      });

      function onAddActivityClick() {
        sheetTitle.textContent = "Add Activity";
        form.reset();
        document.getElementById("activityId").value = "";
        const container = document.getElementById("languageFields");
        container.innerHTML = "";

        availableLanguages.forEach((lang) => {
          const field = document.createElement("div");
          field.className = "space-y-1";
          field.innerHTML = `
            <label class="block font-medium">${lang.name}</label>
            <input
              type="text"
              name="lang-${lang.id}"
              placeholder="Translation in ${lang.name}"
              class="w-full rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
              required
            />
          `;
          container.appendChild(field);
        });

        openSheet("Add Activity");
        if (window.lucide?.createIcons) lucide.createIcons();
      }

      document
        .getElementById("addActivityBtn")
        .addEventListener("click", onAddActivityClick);

      // Exposed (used by action buttons)
      window.editActivity = async function (id) {
        try {
          const res = await fetch(`/api/Activity/GetActivityById/${id}`);
          const data = await res.json();
          if (!res.ok || !data.succeeded) {
            alert("Failed to load Activity for editing");
            return;
          }

          form.reset();
          document.getElementById("activityId").value = data.data.id;
          sheetTitle.textContent = "Update Activity";
          const container = document.getElementById("languageFields");
          container.innerHTML = "";

          availableLanguages.forEach((lang) => {
            const existing = (data.data.name || []).find(
              (n) => n.languageId === lang.id
            );
            const field = document.createElement("div");
            field.className = "space-y-1";
            field.innerHTML = `
              <label class="block font-medium">${lang.name}</label>
              <input
                type="text"
                name="lang-${lang.id}"
                placeholder="Translation in ${lang.name}"
                class="w-full rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition"
                value="${
                  existing
                    ? (existing.translation || "").replace(/"/g, "&quot;")
                    : ""
                }"
                required
              />
              <input type="hidden" name="lang-nameid-${lang.id}" value="${
              existing ? existing.id : ""
            }" />
            `;
            container.appendChild(field);
          });

          openSheet("Update Activity");
          if (window.lucide?.createIcons) lucide.createIcons();
        } catch (err) {
          console.error("Error fetching Activity for edit:", err);
          alert("Error loading Activity");
        }
      };

      window.deleteActivity = async function (id) {
        if (!confirm("Are you sure you want to delete this Activity?")) return;
        try {
          const res = await fetch(`/api/Activity/DeleteActivity/${id}`, {
            method: "DELETE",
          });
          const data = await res.json();
          if (res.ok && data.succeeded) {
            alert("Activity deleted");
            loadActivity(searchInput.value.trim(), currentPage);
          } else {
            alert("Failed to delete Activity");
          }
        } catch (err) {
          console.error(err);
          alert("Error deleting Activity");
        }
      };

      // Form submit (Add or Update)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = form.elements["id"].value;
        const isEdit = Boolean(id);

        try {
          if (!isEdit) {
            // ADD mode: send full array of translations
            const name = availableLanguages.map((lang) => ({
              languageId: lang.id,
              translation: form.elements[`lang-${lang.id}`].value.trim(),
            }));

            const res = await fetch(`/api/Activity/AddActivity`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name }),
            });

            const data = await res.json();
            if (res.ok && data.succeeded) {
              alert("Activity added!");
              form.reset();
              closeSheet();
              loadActivity(searchInput.value.trim(), currentPage);
            } else {
              alert("Failed: " + (data.message || "Unknown error"));
            }
          } else {
            // EDIT mode: update each name[id] individually
            const updatePromises = availableLanguages.map(async (lang) => {
              const translation = form.elements[`lang-${lang.id}`].value.trim();
              const nameId = form.elements[`lang-nameid-${lang.id}`]?.value;

              if (nameId && translation) {
                const response = await fetch(
                  `/api/Activity/UpdateActivity/${nameId}`,
                  {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ translation }),
                  }
                );
                return response.ok;
              } else {
                // If there's no existing nameId, we skip here (or you can create a new translation if your API supports it)
                return true;
              }
            });

            const results = await Promise.all(updatePromises);
            const allOk = results.every(Boolean);

            if (allOk) {
              form.reset();
              closeSheet();
              loadActivity(searchInput.value.trim(), currentPage);
            } else {
              alert("Some translations failed to update.");
            }
          }
        } catch (err) {
          console.error(err);
          alert("Error while saving Activity.");
        }
      });

      // Wire table sort & initial load
      setupTableSort();
      fetchLanguages();
    </script>
    <script src="../js/logout.js" defer></script>
  </body>
</html>
