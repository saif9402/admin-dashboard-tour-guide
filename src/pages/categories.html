<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../output.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>

    <title>Tour Guide Admin Panel</title>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r shadow-md">
        <div class="p-6 border-b">
          <h2 class="text-2xl font-bold text-blue-600 text-center">
            Tour Admin
          </h2>
        </div>
        <nav class="p-4 space-y-3">
          <a
            href="home.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="map"></i> <span>Trips</span>
          </a>
          <a
            href="categories.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 bg-blue-100 shadow-inner font-medium"
          >
            <i data-lucide="folder"></i> <span>Categories</span>
          </a>
          <a
            href="includes.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="check-square"></i> <span>Includes</span>
          </a>
          <a
            href="Languages.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="languages"></i> <span>Languages</span>
          </a>
          <a
            href="activities.html"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="activity"></i> <span>Activities</span>
          </a>
          <a
            href="#"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100"
          >
            <i data-lucide="calendar-check"></i> <span>Bookings</span>
          </a>
          <a
            href="#"
            class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-100"
          >
            <i data-lucide="log-out"></i> <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
        >
          <h1 class="text-3xl font-bold text-gray-900">Manage Categories</h1>
          <button
            class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow"
            id="addCategoryBtn"
          >
            <i data-lucide="plus"></i>
            Add Categories
          </button>
        </div>

        <div class="mb-6">
          <input
            id="searchInput"
            type="text"
            placeholder="Search Category..."
            class="w-full border border-gray-300 focus:ring-2 focus:ring-blue-500 rounded-lg px-4 py-2"
          />
        </div>

        <!-- Trip Table -->
        <div class="bg-white rounded-xl shadow overflow-x-auto">
          <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
              <tr>
                <th class="px-6 py-4">ID</th>
                <th class="px-6 py-4">Category</th>
                <th class="px-6 py-4">Actions</th>
              </tr>
            </thead>
            <tbody id="categoryTable" class="divide-y divide-gray-200 bg-white">
              <!-- Trip rows go here -->
            </tbody>
          </table>
        </div>
        <div
          id="pagination"
          class="mt-6 flex justify-center items-center gap-3 text-sm font-medium"
        ></div>
      </main>
    </div>

    <!-- Modal (hidden by default) -->
    <!-- Floating Drawer Modal -->
    <div
      id="categoryModal"
      class="fixed top-0 right-0 z-50 h-full w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out hidden"
    >
      <div class="p-6 flex flex-col h-full">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">Add Category</h2>
          <button
            type="button"
            id="cancelBtn"
            class="text-gray-500 hover:text-gray-700 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <form
          id="categoryForm"
          class="flex flex-col flex-1 gap-6 overflow-auto"
        >
          <input type="hidden" id="categoryId" name="id" />

          <div class="space-y-1">
            <label class="block font-medium">Category Name</label>
            <input
              title="Name"
              type="text"
              name="Name"
              class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div class="mt-auto flex justify-end space-x-3">
            <button
              type="button"
              id="cancelBtn"
              class="px-5 py-2 rounded bg-gray-200 hover:bg-gray-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-5 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white"
            >
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      lucide.createIcons();

      const modal = document.getElementById("categoryModal");
      const form = document.getElementById("categoryForm");
      const tableBody = document.getElementById("categoryTable");
      const searchInput = document.getElementById("searchInput");

      const API_BASE = "https://tourguidehurghda.runasp.net";
      let currentPage = 1;
      const pageSize = 8;

      async function loadCategories(searchQuery = "", pageNumber = 1) {
        try {
          let url = `${API_BASE}/api/Category/GetAllCategories?pageNumber=${pageNumber}&pageSize=${pageSize}`;
          if (searchQuery) {
            url += `&Search=${encodeURIComponent(searchQuery)}`;
          }

          const res = await fetch(url);
          const data = await res.json();

          if (res.ok && data.succeeded) {
            const categories = data.data.data;
            renderPagination(data.data.pageNumber, data.data.count);

            tableBody.innerHTML = "";

            categories.forEach((cat) => {
              const row = document.createElement("tr");
              row.innerHTML = `
            <td class="px-6 py-3">${cat.id}</td>
            <td class="px-6 py-3">${cat.name}</td>
            <td class="px-6 py-3 flex items-center gap-2">
              <button class="text-blue-400 hover:text-blue-900" title="Edit" onclick="editCategory(${
                cat.id
              }, '${cat.name.replace(/'/g, "\\'")}')">
                <i data-lucide="pencil"></i>
              </button>
              <button class="text-red-400 hover:text-red-900" title="Delete" onclick="deleteCategory(${
                cat.id
              })">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          `;
              tableBody.appendChild(row);
            });
            lucide.createIcons();
          } else {
            alert("Failed to load categories");
          }
        } catch (err) {
          console.error(err);
          alert("Error loading categories");
        }
      }

      function renderPagination(current, totalCount) {
        const paginationContainer = document.getElementById("pagination");
        const totalPages = Math.ceil(totalCount / pageSize);
        paginationContainer.innerHTML = "";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.disabled = current === 1;
        prevBtn.className = "px-4 py-2 bg-gray-200 rounded disabled:opacity-50";
        prevBtn.onclick = () => {
          if (current > 1) {
            currentPage--;
            fetchTrips(currentPage);
          }
        };

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = current === totalPages;
        nextBtn.className = "px-4 py-2 bg-gray-200 rounded disabled:opacity-50";
        nextBtn.onclick = () => {
          if (current < totalPages) {
            currentPage++;
            fetchTrips(currentPage);
          }
        };

        paginationContainer.appendChild(prevBtn);
        paginationContainer.append(` Page ${current} of ${totalPages} `);
        paginationContainer.appendChild(nextBtn);
      }

      searchInput.addEventListener("input", () => {
        currentPage = 1;
        loadCategories(searchInput.value.trim(), currentPage);
      });

      function editCategory(id, name) {
        form.elements["Name"].value = name;
        form.elements["id"].value = id;
        modal.classList.remove("hidden");
        modal.classList.remove("translate-x-full");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = form.elements["id"].value;
        const name = form.elements["Name"].value;
        const formData = { name };

        const isEdit = Boolean(id);

        const endpoint = isEdit
          ? `${API_BASE}/api/Category/UpdateCategory/${id}`
          : `${API_BASE}/api/Category/AddCategory`;

        const method = isEdit ? "PUT" : "POST";

        try {
          const res = await fetch(endpoint, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const data = await res.json();
          if (res.ok && data.succeeded) {
            alert(isEdit ? "Category updated!" : "Category added!");
            form.reset();
            modal.classList.add("translate-x-full");
            setTimeout(() => modal.classList.add("hidden"), 300);
            loadCategories();
          } else {
            alert("Failed: " + (data.message || "Unknown error"));
          }
        } catch (err) {
          console.error(err);
          alert("Error while saving category.");
        }
      });

      async function deleteCategory(id) {
        if (!confirm("Are you sure you want to delete this category?")) return;

        try {
          const res = await fetch(
            `${API_BASE}/api/Category/DeleteCategory/${id}`,
            {
              method: "DELETE",
            }
          );

          const data = await res.json();
          if (res.ok && data.succeeded) {
            alert("Category deleted");
            loadCategories(searchInput.value.trim(), currentPage);
          } else {
            alert("Failed to delete category");
          }
        } catch (err) {
          console.error(err);
          alert("Error deleting category");
        }
      }

      document
        .getElementById("addCategoryBtn")
        .addEventListener("click", () => {
          modal.classList.remove("hidden");
          setTimeout(() => modal.classList.remove("translate-x-full"), 10);
        });

      document.querySelectorAll("#cancelBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          modal.classList.add("translate-x-full");
          setTimeout(() => modal.classList.add("hidden"), 300);
          form.reset();
        });
      });

      loadCategories(searchInput.value.trim(), currentPage);
    </script>
  </body>
</html>
